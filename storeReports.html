<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Store Performance Dashboard</title>

<style>
body {
    font-family: Arial, sans-serif;
    font-weight: bold;
    background: #f4f6f9;
    margin: 0;
    overflow: hidden;
}

h1 {
    text-align: center;
    padding: 20px;
    background: #34495e;
    color: white;
    margin: 0;
}

#clock {
    text-align: center;
    font-size: 1.6rem;
    margin: 10px 0;
    color: #2c3e50;
}

.table-container {
    height: 85vh;
    overflow-y: auto;
    width: 95%;
    margin: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

th, td {
    padding: 12px;
    text-align: center;
    border: 1px solid #ddd;
}

th {
    background: #2c3e50;
    color: white;
    position: sticky;
    top: 0;
}

.score-high { background: #27ae60; color: white; }
.score-medium { background: #f1c40f; color: black; }
.score-low { background: #e74c3c; color: white; }

.footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: #ecf0f1;
    text-align: center;
    font-size: 14px;
    padding: 6px;
}
</style>
</head>

<body>

<h1>Store Performance Report</h1>
<div id="clock"></div>

<div class="table-container">
<table>
<thead>
<tr>
    <th>Store Attendant</th>
    <th>Branch</th>
    <th>Total Orders</th>
    <th>Line Items</th>
    <th>Avg Items / Order</th>
    <th>Orders / Hour</th>
    <th>Efficiency (%)</th>
</tr>
</thead>
<tbody id="performanceBody"></tbody>
</table>
</div>

<!-- ===== FIXED FOOTER ===== -->
<div class="footer">
    <div>Last updated: <span id="lastUpdated"></span></div>
    <div>Designed and Managed by MIS.DPT</div>
</div>

<script src="config.js"></script>

<script>
// ===== CLOCK =====
function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent =
        now.toLocaleDateString(undefined, { weekday:"short", year:"numeric", month:"short", day:"numeric" }) +
        " â€“ " + now.toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

// ===== DATE =====
const today = new Date().toISOString().split("T")[0];

// ===== URL PARAM =====
const branchId = new URLSearchParams(window.location.search).get("branch") || "orgbranch-default";

const API_URL = `${window.API_CONFIG.API_URL}store-picker-reports?orgBranchId=${branchId}&startDate=${today}`;
const API_TOKEN = window.API_CONFIG.API_TOKEN;

// ===== PERCENTILE SCORING =====
function calculatePercentilePerformance(attendants) {

    const ordersPerHourArr = attendants.map(a => (a.numberOfOrders || 0) / 8);
    const avgItemsArr = attendants.map(a => a.numberOfOrders ? a.numberOfLineItems / a.numberOfOrders : 0);

    function percentile(arr, val) {
        return arr.length ? (arr.filter(v => v <= val).length / arr.length) * 100 : 0;
    }

    attendants.forEach(a => {
        const ordersPerHour = (a.numberOfOrders || 0) / 8;
        const avgItems = a.numberOfOrders ? a.numberOfLineItems / a.numberOfOrders : 0;

        a.performance = {
            ordersPerHour,
            avgItemsPerOrder: avgItems,
            score:
                percentile(ordersPerHourArr, ordersPerHour) * 0.6 +
                percentile(avgItemsArr, avgItems) * 0.4
        };
    });
}

// ===== SCORE COLOR =====
function scoreClass(score) {
    if (score >= 70) return "score-high";
    if (score >= 50) return "score-medium";
    return "score-low";
}

// ===== LOAD DATA =====
async function loadPerformanceData() {
    const tbody = document.getElementById("performanceBody");

    tbody.innerHTML = `<tr><td colspan="7">Loading...</td></tr>`;

    try {
        const res = await fetch(API_URL, {
            headers: { Authorization: API_TOKEN }
        });

        const json = await res.json();
        const attendants = json.data || json || [];

        if (!attendants.length) {
            tbody.innerHTML = `<tr><td colspan="7">No data</td></tr>`;
            return;
        }

        calculatePercentilePerformance(attendants);

        attendants.sort((a,b) => b.performance.score - a.performance.score);

        tbody.innerHTML = attendants.map(a => `
            <tr>
                <td>${a.storePickerName}</td>
                <td>${a.orgBranchName}</td>
                <td>${a.numberOfOrders}</td>
                <td>${a.numberOfLineItems}</td>
                <td>${a.performance.avgItemsPerOrder.toFixed(2)}</td>
                <td>${a.performance.ordersPerHour.toFixed(2)}</td>
                <td class="${scoreClass(a.performance.score)}">
                    ${a.performance.score.toFixed(1)}%
                </td>
            </tr>
        `).join("");

        document.getElementById("lastUpdated").textContent = new Date().toLocaleTimeString();
        startAutoScroll();

    } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="7" style="color:red">Error loading data</td></tr>`;
    }
}

// ===== AUTO SCROLL =====
let scrollInterval;
function startAutoScroll() {
    const container = document.querySelector(".table-container");
    clearInterval(scrollInterval);

    if (container.scrollHeight <= container.clientHeight) return;

    let dir = 1;
    scrollInterval = setInterval(() => {
        container.scrollTop += dir;
        if (container.scrollTop >= container.scrollHeight - container.clientHeight) dir = -1;
        if (container.scrollTop <= 0) dir = 1;
    }, 40);
}

// ===== AUTO REFRESH =====
setInterval(loadPerformanceData, 60000);
loadPerformanceData();
</script>

</body>
</html>
